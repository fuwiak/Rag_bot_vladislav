# Исправление ошибки 400 при тестировании моделей

## Проблема

При попытке протестировать модель получаете ошибку:
```
Failed to load resource: the server responded with a status of 400 ()
```

## Возможные причины

### 1. OPENROUTER_API_KEY не установлен

**Проверка:**
- Railway Dashboard → Backend сервис → Settings → Variables
- Убедитесь, что переменная `OPENROUTER_API_KEY` установлена

**Решение:**
1. Получите API ключ на [OpenRouter](https://openrouter.ai/keys)
2. Добавьте в Railway:
   ```
   OPENROUTER_API_KEY=your-actual-api-key-here
   ```
3. БЕЗ кавычек, БЕЗ пробелов
4. Дождитесь пересборки backend

### 2. Неправильный формат model_id

**Проверка:**
- Откройте консоль браузера (F12)
- Найдите `Sending test request:` - проверьте `model_id`
- Должен быть в формате: `openai/gpt-4` или `x-ai/grok-4.1-fast`

**Решение:**
- Убедитесь, что выбрана модель из списка доступных
- Не используйте кастомные ID, если модель не добавлена в базу

### 3. Неправильный формат messages

**Проверка:**
- В консоли браузера проверьте формат `messages`
- Должен быть массив объектов: `[{ role: 'user', content: '...' }]`

**Решение:**
- Формат уже правильный в коде
- Если видите другую структуру - это баг, сообщите

### 4. OpenRouter API ошибка

**Проверка:**
- Откройте консоль браузера (F12)
- Найдите `Error testing model:` - там будет детальная ошибка от OpenRouter

**Возможные ошибки:**
- `Invalid API key` - неправильный ключ
- `Model not found` - модель недоступна
- `Rate limit exceeded` - превышен лимит запросов
- `Insufficient credits` - недостаточно средств на аккаунте

## Отладка

### Шаг 1: Проверьте консоль браузера

1. Откройте консоль (F12)
2. Попробуйте протестировать модель
3. Найдите:
   - `Sending test request:` - что отправляется
   - `Error testing model:` - детали ошибки

### Шаг 2: Проверьте логи backend

1. Railway Dashboard → Backend сервис → Logs
2. Ищите ошибки при тестировании модели
3. Должны быть детали от OpenRouter API

### Шаг 3: Проверьте переменные окружения

1. Railway Dashboard → Backend сервис → Settings → Variables
2. Убедитесь, что установлены:
   - `OPENROUTER_API_KEY` - ваш API ключ
   - `APP_URL` - URL вашего приложения (для HTTP-Referer)

## Быстрое решение

Если ошибка 400, скорее всего проблема в `OPENROUTER_API_KEY`:

1. **Проверьте ключ:**
   - Откройте [OpenRouter Dashboard](https://openrouter.ai/keys)
   - Убедитесь, что ключ активен и имеет кредиты

2. **Обновите в Railway:**
   - Backend сервис → Variables → `OPENROUTER_API_KEY`
   - Вставьте правильный ключ
   - Сохраните и дождитесь пересборки

3. **Проверьте работу:**
   - Попробуйте протестировать модель снова
   - В консоли браузера должны быть детали ошибки, если проблема сохраняется

## Если проблема сохраняется

После улучшения обработки ошибок, в консоли браузера будет видно точную причину ошибки 400. Используйте эту информацию для дальнейшей диагностики.

