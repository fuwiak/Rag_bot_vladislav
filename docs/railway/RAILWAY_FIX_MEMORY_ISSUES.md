# Исправление проблем с памятью при загрузке документов

## Проблема

При загрузке даже маленьких PDF или DOCX файлов deployment на Railway выходит из памяти и падает:
```
Deploy Ran Out of Memory!
Your deployment ran out of memory within the production environment and crashed.
```

## Причины

1. **Весь файл загружается в память** - `file.read()` читает весь файл целиком
2. **Несколько файлов обрабатываются одновременно** - все файлы хранятся в памяти до завершения обработки
3. **Парсинг PDF/DOCX требует много памяти** - библиотеки для парсинга могут использовать много памяти
4. **Эмбеддинги создаются для всех чанков сразу** - может потребовать много памяти для больших документов

## Решения

### 1. Лимит размера файла (уже реализовано)

Добавлен лимит размера файла по умолчанию: **10MB**

Можно настроить через переменную окружения:
```
MAX_DOCUMENT_SIZE=10485760  # в байтах (10MB)
```

Файлы больше лимита будут отклоняться с ошибкой 413.

### 2. Очистка памяти (уже реализовано)

После обработки документа вызывается `gc.collect()` для принудительной очистки памяти.

### 3. Увеличить лимит памяти на Railway

**Railway Dashboard → Backend сервис → Settings → Resources**

Увеличьте лимит памяти:
- Минимум: **512MB** (рекомендуется для небольших файлов)
- Рекомендуется: **1GB** (для файлов до 10MB)
- Для больших файлов: **2GB** или больше

### 4. Обрабатывать файлы по одному

Если загружаете несколько файлов, обрабатывайте их по одному, а не все сразу.

### 5. Оптимизировать парсинг

Для очень больших файлов можно:
- Разбивать файл на части перед парсингом
- Использовать streaming парсинг (если библиотеки поддерживают)
- Обрабатывать страницы/разделы по отдельности

## Рекомендации

1. **Установите лимит размера файла:**
   ```
   MAX_DOCUMENT_SIZE=10485760  # 10MB
   ```

2. **Увеличьте память на Railway:**
   - Минимум 512MB, рекомендуется 1GB

3. **Загружайте файлы по одному:**
   - Не загружайте несколько больших файлов одновременно
   - Дождитесь завершения обработки одного файла перед загрузкой следующего

4. **Мониторьте использование памяти:**
   - Railway Dashboard → Backend сервис → Metrics
   - Следите за использованием памяти

## Проверка

После применения исправлений:

1. Попробуйте загрузить маленький файл (< 1MB)
2. Проверьте логи backend - не должно быть ошибок памяти
3. Проверьте метрики Railway - использование памяти должно быть стабильным

## Если проблема сохраняется

1. **Уменьшите лимит размера файла:**
   ```
   MAX_DOCUMENT_SIZE=5242880  # 5MB
   ```

2. **Увеличьте память на Railway до 2GB**

3. **Проверьте логи backend** - там должны быть детали ошибки

4. **Рассмотрите использование внешнего хранилища** (S3, etc.) для больших файлов

